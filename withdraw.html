<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Withdraw - EXARAI</title>
  <!-- Ù†ÙØ³ Ù…Ù„Ù Ø§Ù„Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ø£ØµÙ„ÙŠ -->
  <link rel="stylesheet" href="withdraw-style.css" />
  <!-- Ø³ØªØ§ÙŠÙ„ Ø¨Ø³ÙŠØ· ÙÙ‚Ø· Ù„Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© ÙˆØ£ÙŠÙ‚ÙˆÙ†Ø© Ø§Ù„Ù‡ÙŠØ¯Ø± -->
  <style>
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal {
      background: #14151a;
      border-radius: 12px;
      padding: 16px;
      width: 90%;
      max-width: 400px;
      color: #ffffff;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.6);
      box-sizing: border-box;
    }
    .modal-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 12px;
    }
    .wallet-type-row {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }
    .wallet-type-btn {
      flex: 1;
      border-radius: 999px;
      padding: 8px 10px;
      border: 1px solid #2a2b32;
      background: #181921;
      color: #ffffff;
      font-size: 14px;
    }
    .wallet-type-btn.active {
      border-color: #3f8cff;
      background: #1f2433;
    }
    .modal-field-label {
      font-size: 13px;
      margin-bottom: 4px;
    }
    .modal-input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid #2a2b32;
      background: #101117;
      color: #ffffff;
      font-size: 14px;
      box-sizing: border-box;
    }
    .modal-actions {
      display: flex;
      gap: 10px;
      margin-top: 16px;
    }
    .modal-btn {
      flex: 1;
      padding: 10px 12px;
      border-radius: 999px;
      font-size: 14px;
      border: none;
    }
    .modal-btn.cancel {
      background: #2a2b32;
      color: #ffffff;
    }
    .modal-btn.confirm {
      background: #3f8cff;
      color: #ffffff;
    }
    .address-row.has-value .select-placeholder {
      color: #ffffff;
    }
    .address-text {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .header-icon-img {
      width: 18px;
      height: 18px;
      display: block;
    }
  </style>
</head>
<body>
  <div class="app">
    <header class="app-header">
      <a href="javascript:history.back()" class="back-btn">
        <div class="back-arrow"></div>
      </a>
      <div class="app-header-title">Withdraw</div>
      <div class="header-icon" id="billsIcon">
        <img src="images/back-icon-D2ne3Npi.png" alt="Bills" class="header-icon-img" />
      </div>
    </header>

    <main class="app-main">
      <div class="section-label">Withdrawal Currency</div>
      <div class="select-box">
        <!-- ÙÙ‚Ø· USDT Ø¨Ø¯ÙˆÙ† Ø³Ù‡Ù… -->
        <span class="select-value">USDT</span>
      </div>

      <div class="section-label">Withdrawal Network</div>
      <div class="network-row">
        <button type="button" class="network-pill active">TRC20</button>
      </div>

      <div class="section-label">Withdrawal Address</div>
      <div class="select-box address-row" id="addressRow">
        <span class="select-placeholder address-text" id="addressText">Please select an address</span>
        <div class="address-icon">ðŸ‘¤</div>
      </div>

      <button type="button" class="add-address-btn" id="addAddressBtn">Add address</button>

      <div class="section-label">Quantity</div>
      <div class="select-box qty-box">
        <input class="qty-input" id="qtyInput" type="number" min="0" step="0.01"
               placeholder="Enter Withdrawal Quantity" />
        <div class="qty-right">
          <span class="qty-unit" id="qtyUnit">USDT</span>
          <span class="qty-max" id="maxLink">MAX</span>
        </div>
      </div>

      <div class="available-row">
        Available <span class="value" id="availableVal">3.06 USDT</span>
      </div>

      <div class="info-card">
        <div class="info-row">
          <span>Minimum Withdrawal Quantity</span>
          <span><span id="minQty">20</span> <span id="minQtySymbol">USDT</span></span>
        </div>
        <div class="info-row">
          <span>Withdrawal Fee</span>
          <span><span id="feeVal">0</span> <span id="feeSymbol">USDT</span></span>
        </div>
        <div class="info-row">
          <span>Received Quantity</span>
          <span><span id="recvVal">0</span> <span id="recvSymbol">USDT</span></span>
        </div>
      </div>

      <button type="button" class="withdraw-btn" id="withdrawBtn">Withdraw</button>

      <div class="reminder-title">Friendly Reminder</div>
      <ol class="reminder-list">
        <li>The minimum withdrawal amount is: <span class="reminder-em">20 USDT</span></li>
        <li>Withdrawal fee: <span class="reminder-em">5%</span></li>
        <li>Withdrawals will arrive within 2â€“120 hours.</li>
        <li>After completing <span class="reminder-em">6</span> AI computing power tasks, you can apply for withdrawal.</li>
        <li>Make sure your computer and browser are secure to prevent information from being tampered with or leaked.</li>
        <li>Before withdrawing coins, please confirm whether the withdrawal address is safe and corresponds to the current currency. Once the address of a nonâ€‘TRC20 network is used, the platform cannot help to retrieve it. Please check carefully before withdrawing coins.</li>
      </ol>
    </main>
  </div>

  <!-- Ù†Ø§ÙØ°Ø© Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù†ÙˆØ§Ù† -->
  <div class="modal-backdrop" id="addressModal">
    <div class="modal">
      <div class="modal-title">Add withdrawal address</div>
      <div class="modal-field-label">Wallet type</div>
      <div class="wallet-type-row">
        <button type="button" class="wallet-type-btn" data-type="internal" id="walletInternal">Internal wallet</button>
        <button type="button" class="wallet-type-btn" data-type="external" id="walletExternal">External wallet</button>
      </div>
      <div class="modal-field-label">Address (TRC20)</div>
      <input type="text" id="addressInput" class="modal-input" placeholder="Paste TRC20 withdrawal address" />
      <div class="modal-actions">
        <button type="button" class="modal-btn cancel" id="modalCancel">Cancel</button>
        <button type="button" class="modal-btn confirm" id="modalConfirm">Confirm</button>
      </div>
    </div>
  </div>

  <script>
    (function() {
      var qtyInput = document.getElementById('qtyInput');
      var feeVal = document.getElementById('feeVal');
      var recvVal = document.getElementById('recvVal');
      var minQty = 20;
      var minQtySymbol = document.getElementById('minQtySymbol');
      var feeSymbol = document.getElementById('feeSymbol');
      var recvSymbol = document.getElementById('recvSymbol');
      var maxAvailable = 0;
      var maxLink = document.getElementById('maxLink');
      var withdrawBtn = document.getElementById('withdrawBtn');
      var availableVal = document.getElementById('availableVal');
      var qtyUnit = document.getElementById('qtyUnit');

      var addressRow = document.getElementById('addressRow');
      var addressText = document.getElementById('addressText');
      var addAddressBtn = document.getElementById('addAddressBtn');

      var addressModal = document.getElementById('addressModal');
      var modalCancel = document.getElementById('modalCancel');
      var modalConfirm = document.getElementById('modalConfirm');
      var addressInput = document.getElementById('addressInput');
      var walletInternal = document.getElementById('walletInternal');
      var walletExternal = document.getElementById('walletExternal');

      var billsIcon = document.getElementById('billsIcon');

      var currentUser = null;
      var balances = { USDT: 0 };
      var balance = 0;
      var selectedWalletType = null;
      var selectedAddress = null;

      // Ø£ÙŠÙ‚ÙˆÙ†Ø© Bills
      if (billsIcon) {
        billsIcon.addEventListener('click', function() {
          window.location.href = 'Bills.html';
        });
      }

      // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±ØµÙŠØ¯ Ù…Ù† ExaAuth
      if (window.ExaAuth) {
        currentUser = ExaAuth.getCurrentUser && ExaAuth.getCurrentUser();
        if (currentUser && typeof currentUser.usdtBalance === 'number') {
          balances.USDT = currentUser.usdtBalance;
        }
      }

      function refreshBalance() {
        balance = balances.USDT || 0;
        maxAvailable = balance;
        if (availableVal) {
          availableVal.textContent = balance.toFixed(2) + ' USDT';
        }
        if (qtyUnit) qtyUnit.textContent = 'USDT';
        if (minQtySymbol) minQtySymbol.textContent = 'USDT';
        if (feeSymbol) feeSymbol.textContent = 'USDT';
        if (recvSymbol) recvSymbol.textContent = 'USDT';
        updateValues();
      }

      function updateValues() {
        var v = parseFloat(qtyInput.value);
        if (isNaN(v) || v <= 0) {
          feeVal.textContent = '0';
          recvVal.textContent = '0';
          return;
        }
        var fee = v * 0.05;
        var received = v - fee;
        feeVal.textContent = fee.toFixed(2);
        recvVal.textContent = received.toFixed(2);
      }

      if (qtyInput) {
        qtyInput.addEventListener('input', updateValues);
      }

      if (maxLink) {
        maxLink.addEventListener('click', function() {
          qtyInput.value = maxAvailable.toFixed(2);
          updateValues();
        });
      }

      // ÙØªØ­ ÙˆØ¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¨ÙˆØ¨ Ø£Ø¨
      function openAddressModal() {
        if (!addressModal) return;
        addressModal.style.display = 'flex';
        selectedWalletType = null;
        addressInput.value = '';
        walletInternal.classList.remove('active');
        walletExternal.classList.remove('active');
      }

      function closeAddressModal() {
        if (!addressModal) return;
        addressModal.style.display = 'none';
      }

      if (walletInternal) {
        walletInternal.addEventListener('click', function() {
          selectedWalletType = this.getAttribute('data-type');
          walletInternal.classList.add('active');
          walletExternal.classList.remove('active');
        });
      }

      if (walletExternal) {
        walletExternal.addEventListener('click', function() {
          selectedWalletType = this.getAttribute('data-type');
          walletExternal.classList.add('active');
          walletInternal.classList.remove('active');
        });
      }

      if (addAddressBtn) {
        addAddressBtn.addEventListener('click', openAddressModal);
      }
      if (addressRow) {
        addressRow.addEventListener('click', openAddressModal);
      }

      if (modalCancel) {
        modalCancel.addEventListener('click', function() {
          closeAddressModal();
        });
      }

      // ÙØ­Øµ Ø¹Ù†ÙˆØ§Ù† TRC20
      function isValidTRC20Address(addr) {
        // Ø¹Ù†ÙˆØ§Ù† TRON/TRC20 ÙŠØ¨Ø¯Ø£ Ø¨Ù€ T ÙˆØ·ÙˆÙ„Ù‡ 26-34 Ø­Ø±Ù Ù…Ù† base58 (Ø¨Ø¯ÙˆÙ† 0 O I l)
        var re = /^T[1-9A-HJ-NP-Za-km-z]{25,33}$/;
        return re.test(addr);
      }

      if (modalConfirm) {
        modalConfirm.addEventListener('click', function() {
          if (!selectedWalletType) {
            alert('Please select a wallet type.');
            return;
          }
          var addr = (addressInput.value || '').trim();
          if (!addr) {
            alert('Please enter a withdrawal address.');
            return;
          }
          if (!isValidTRC20Address(addr)) {
            alert('Invalid TRC20 address. It should start with T and be 26-34 characters long.');
            return;
          }
          selectedAddress = {
            type: selectedWalletType,
            address: addr
          };

          var shortAddr = addr;
          if (addr.length > 18) {
            shortAddr = addr.slice(0, 8) + '...' + addr.slice(-6);
          }
          if (addressText) {
            addressText.textContent = shortAddr;
          }
          if (addressRow) {
            addressRow.classList.add('has-value');
          }
          closeAddressModal();
        });
      }

      // Ø²Ø± Ø§Ù„Ø³Ø­Ø¨
      if (withdrawBtn) {
        withdrawBtn.addEventListener('click', function() {
          if (!window.ExaAuth || !currentUser) {
            alert('Internal error: user not loaded.');
            return;
          }

          if (!selectedAddress) {
            alert('Please add a withdrawal address.');
            return;
          }

          var v = parseFloat(qtyInput.value);
          if (isNaN(v) || v <= 0) {
            alert('Please enter a valid amount.');
            return;
          }

          if (v < minQty) {
            alert('The minimum withdrawal amount is ' + minQty + ' USDT.');
            return;
          }

          if (v > balance) {
            alert('Insufficient balance.');
            return;
          }

          var fee = v * 0.05;
          var received = v - fee;

          var tx = {
            id: 'wd_' + Date.now(),
            type: 'withdraw',
            currency: 'USDT',
            amount: v,
            fee: fee,
            net: received,
            status: 'PENDING',
            createdAt: new Date().toISOString(),
            network: 'TRC20',
            walletType: selectedAddress.type,
            address: selectedAddress.address
          };

          if (typeof ExaAuth.addTransaction === 'function') {
            ExaAuth.addTransaction(currentUser.uid, tx);
          }

          // Ø®ØµÙ… Ù…Ù† Ø§Ù„Ø±ØµÙŠØ¯ ÙˆÙ†Ù‚Ù„Ù‡ Ù„Ù„Ù…Ø¬Ù…Ù‘Ø¯
          balances.USDT = (balances.USDT || 0) - v;
          if (balances.USDT < 0) balances.USDT = 0;
          currentUser.usdtBalance = parseFloat(balances.USDT.toFixed(2));

          var frozen = typeof currentUser.frozenBalance === 'number' ? currentUser.frozenBalance : 0;
          currentUser.frozenBalance = parseFloat((frozen + v).toFixed(2));

          if (typeof ExaAuth.updateUser === 'function') {
            ExaAuth.updateUser(currentUser);
          } else if (typeof ExaAuth.setCurrentUser === 'function') {
            ExaAuth.setCurrentUser(currentUser);
          }

          qtyInput.value = '';
          updateValues();
          refreshBalance();

          alert('Withdrawal request submitted and is pending review.');
        });
      }

      refreshBalance();
    })();
  </script>

  <script src="auth.js"></script>
  <script src="common-nav.js"></script>
</body>
</html>
